# Endpoints
The API is accessed by making HTTP requests to an endpoint URL, in which GET, POST, PUT, PATCH, and DELETE methods dictate how you interact with the information available.

The default base URL for all the HTTP endpoints is:
> `http://$hostname:$port/libvirt/`

`$hostname` and `$port` being the address and port of the Web API server

# Requests
Requests must be sent over HTTP with any payload formatted in JSON. All requests must include both `X-AUTH-KEY` and `X-AUTH-USERNAME` headers to authenticate. Requests that use `X-AUTH-USER-SERVICE-KEY` can use that instead of the Auth-Key and Auth-Username headers.

## Required parameters
| Name | Format | Description |
| ---- | ------ | ----------- |
| API Key | X-Auth-Key | API key generated by command and stored into config.ini |
| Username | X-Auth-Username | Username associated with a user of group libvirt and kvm |
| User Service Key | X-Auth-User-Service-Key | Special API key good for restricted set of endpoints |

## Example request
Requests generally formatted as follows:
> `GET obect/:object_id`

### Auth-Username cURL _(example)_
```bash
curl -X GET "http://127.0.0.1:8081/libvirt/domains/14" \
     -H "Content-Type:application/json" \
     -H "X-Auth-Key:1234567893feefc5f0q5000bfo0c38d90bbeb" \
     -H "X-Auth-Username:smith"
```

### User-Service cURL _(example)_
```bash
curl -X GET "http://127.0.0.1:8081/libvirt/domains/14" \
     -H "Content-Type:application/json" \
     -H "X-Auth-Key:1234567893feefc5f0q5000bfo0c38d90bbeb" \
     -H "X-Auth-User-Service-Key:v1.0-e24fd090c02efcfecb4de8f4ff24..."
```

# Responses
## Format
Each response is a JSON object. The data requeste is wrapped in the `RESULT` tag. If you have a response, it will always be within the `RESULT` field. We also include a `SUCCESS` flag, an array of porential `ERRORS`, and `MESSAGE` in the response. Some responses can have additional pagination info wrapped in the `RESULT_INFO`

An error object will contain an integer `CODE` field and a `MESSAGE`

Date fields will always be in UTC ISO-8601 format, including microseconds.

### Success Response _(example)_
```json
{
  "results": [
    {
      "uuid": "4dea22b3-1d52-d8f3-2516-782e98ab3fa0",
      "name": "debian-vm",
      "...": "..."
    },
    {
      "uuid": "fa8e1003-1f3f-4a92-a829-66dd523a68f5",
      "name": "manjaro",
      "...": "..."
    }
  ],
  "success": true,
  "errors": [],
  "messages": []
}
```

### Error Response _(example)_
```json
{
  "results": [],
  "success": false,
  "errors": [
    {
      "code": 42,
      "message": "Invalid or missing domain."
    }
  ],
  "messages": []
}
```

# Domains
A Domain is a virtual machine on host

## List Domains
List, search, sort, and filter your domains
> `GET domains`
### Optional parameters
| Name _type_ | Description _example_ | Constraints |
| ----------- | --------------------- | ----------- |
| name _string_ | Domain common name _debian-vm_ | max length: 253 |
| uuid _string_ | Domain unique identifier _4dea22b3-1d52-d8f3-2516-782e98ab3fa0_ | length: 32 characters |
| state _number_ | Domain state _1_ | valid values:<br/>0: no state,<br/>1: running,<br/>2: blocked on resource,<br/>3: paused by user,<br/>4: being shut down,<br/>5: shut off, 6: crashed,<br/>7:suspended by guest power management |
| active _boolean_ | Activity specifier | _true_ or _false_ |
| persistent _boolean_ | Persistence specifier | _true_ or _false_ |
| managed_save _boolean_ | Save management policy specifier | _true_ or _false_ |
| has_snapshot _boolean_ | Snaphshot policy specifier | _true_ or _false_ |

#### cURL _(example)_
```bash
curl -X GET "http://127.0.0.1:8081/libvirt/domains?name=debian-vm&state=1" \
     -H "Content-Type:application/json" \
     -H "X-Auth-Key:1234567893feefc5f0q5000bfo0c38d90bbeb" \
     -H "X-Auth-Username:smith"
```

## Create Domain
#### cURL _(example)_
```bash
curl -X POST "http://127.0.0.1:8081/libvirt/domains" \
     -H "Content-Type:application/json" \
     -H "X-Auth-Key:1234567893feefc5f0q5000bfo0c38d90bbeb" \
     -H "X-Auth-Username:smith" \
     --data '{"name":"fedora-vm","os":"Linux"}'
```

## Domains Details
> `GET domains/:identifier`
#### cURL _(example)_

```bash
curl -X GET "http://127.0.0.1:8081/libvirt/domains/4dea22b3-1d52-d8f3-2516-782e98ab3fa0" \
     -H "Content-Type:application/json" \
     -H "X-Auth-Key:1234567893feefc5f0q5000bfo0c38d90bbeb" \
     -H "X-Auth-Username:smith"
```

## Manage domains
> `PATCH domains/:identifier`

### Power management _(JSon grammar)_
```json
[
  {
    "power_mgt": "$VALUE"
  }
]
```

**$VALUE** can be a _string_ (see **$ACTION values**) or a _JSon Object_ :

```json
{
  "$VALUE": {
    "request": "$ACTION",
    "type": "$FLAGS"
  }
}
```

For flags, see [Power management flags](https://github.com/ShinoYasx/HeavyEyelid/wiki/Flags#power-management-flags).

If no flags specified, using _DEFAULT_.

#### $ACTION values _(according to virsh)_

| Value _(string)_	| Action		|
| ------------------	| ----------	|
| start				| Start a (previously defined) inactive domain |
| shutdown			| Gracefully shutdown a domain |
| destroy			| Destroy (stop) a domain |
| reboot				| Reboot a domain |
| reset				| Reset a domain	|
| suspend			| Suspend (pause) a domain	|
| resume				| Resume (unpause)	|

### cURL _(example: start)_

```bash
curl -X PATCH "http://127.0.0.1:8081/libvirt/domains/by-name/debian-vm" \
     -H "Content-Type:application/json" \
     -H "X-Auth-Key:1234567893feefc5f0q5000bfo0c38d90bbeb" \
     -H "X-Auth-Username:smith" \
     --data '[{"power_mgt":{"request":"start", "type":"ACPI_POWER_BTN"}}]'
```

#### Success response _(example)_
```json
{
  "results": [],
  "success": true,
  "errors": [],
  "messages": [
    {
      "start": "Domain started"
    }
  ]
}
```

#### Error response _(example)_
```json
{
  "results": [],
  "success": false,
  "errors": [
    {
      "code": 201,
      "message": "Domain is already active"
    }
  ],
  "messages": []
}
```